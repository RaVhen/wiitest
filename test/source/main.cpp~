/*===========================================
           GRRLIB (GX Version)

            ESIEA Wii Project
============================================*/

#include <grrlib.h>
#include <wiiuse/wpad.h>
#include <stdlib.h> 
#include "movement.h"

//Fonts in Data files
#include "font_png.h"
#include "pointer_png.h"
#include "titlescreen_png.h"

/*//Colors
#define CLR_WHITE 0xFFFFFFFF
#define CLR_BLACK 0x000000FF
#define CLR_UNKNOW 0x88888888

// Screen values
#define maxX 640
#define maxY 480*/

GXRModeObj* IR_Init(){
  GXRModeObj *rmode = NULL;
  rmode = VIDEO_GetPreferredMode(NULL);
  return rmode;
}

void bMove(Button& b, ir_t irPointer){
  if(irPointer.y + b.height > maxY)
    b.y = maxY - b.height;
  else
    b.y = irPointer.y;
}

int main() {
	
	// Graphique render
	GRRLIB_Init();
	
	// Wiimotes
	WPAD_Init();
	// IR init
	rmode = VIDEO_GetPreferredMode(NULL);
	GXRModeObj *rmode = IR_Init();
	WPAD_SetVRes(WPAD_CHAN_ALL,rmode->fbWidth,rmode->xfbHeight);
	WPAD_SetDataFormat(WPAD_CHAN_0,WPAD_FMT_BTNS_ACC_IR);
	
	//IR pointer
	ir_t irPointer;

	// Data textures
	GRRLIB_texImg * texFont = GRRLIB_LoadTexture(font_png);
	GRRLIB_InitTileSet(texFont, 8, 16, 0);
	GRRLIB_texImg* pointer = GRRLIB_LoadTexture(pointer_png);
	GRRLIB_SetMidHandle(pointer,true);
	GRRLIB_texImg* titlescreen = GRRLIB_LoadTexture(titlescreen_png);

	// Objects
	Button testButton;
	testButton.initButton(256,320,128,80);
	Button left;
	left.initButton(0,maxY/2,15,40);
	Button right;
	right.initButton(maxX-15,0,15,40);	
	Circle move;
	move.initCircle(maxX/2,maxY/2,20);

	// Globals variables
	bool finProgramme = false;	
	int pass = 0;
	float a = 1.0,b=0.0;
	float teta=0.0;

	while (!finProgramme){
		

	  WPAD_ScanPads();  //Scan wiimotes
	  WPAD_IR(WPAD_CHAN_0, &irPointer);
	  
	  if (WPAD_ButtonsDown(0) & WPAD_BUTTON_HOME) finProgramme = true;
	
	  //==================== DRAW PART ========================
	  GRRLIB_Rectangle(testButton.x, testButton.y, testButton.width, testButton.height, CLR_WHITE,1);
	  GRRLIB_Rectangle(left.x, left.y, left.width, left.height, CLR_WHITE,1);
	  GRRLIB_Rectangle(right.x, right.y, right.width, right.height, CLR_WHITE,1);
	  GRRLIB_Circle(move.x, move.y, move.radius, CLR_WHITE,2);
	  GRRLIB_Printf(testButton.x + 48, testButton.y + 28, texFont, CLR_BLACK, 2, "OK");	  
	  //GRRLIB_DrawImg(irPointer.x, irPointer.y, pointer, 0, 1, 1, CLR_WHITE);
	  //================ END DRAW =============================

	  //================= TEST PART============================
	  //GRRLIB_DrawImg(0,0,titlescreen,0,1,1,CLR_UNKNOW);
	  char* posX =(char*)malloc(sizeof(char));
	  char* posY =(char*)malloc(sizeof(char));
	  //char* pos =(char*)malloc(sizeof(char));
	  sprintf(posX,"%.3f",irPointer.x);
	  sprintf(posY,"%.3f",irPointer.y);
	  //sprintf(pos,"%f%f",irPointer.x,irPointer.y);
	  GRRLIB_Printf(20 + 15, 16 + 15,texFont,  CLR_WHITE, 2 , posX);
	  GRRLIB_Printf(20 + 15, 16 + 60,texFont,  CLR_WHITE, 2 , posY);
	  free(posX);
	  free(posY);
	  GRRLIB_Render();
	  if(isIn(move,right))
	     GRRLIB_Printf( 48,  95, texFont, CLR_WHITE, 2, " right yes");
	  
	  if(isIn(move,left))
	     GRRLIB_Printf( 48,  125, texFont, CLR_WHITE, 2, " left yes");
	  //================== END TEST ==============================


	  isMoving(move, right, left, pass,speed,b,teta);
	  bMove(right,irPointer);
	  ia(left,move,a);
	  char* value =(char*)malloc(sizeof(char));
	  sprintf(value,"%f",b);
	  GRRLIB_Printf(20 + 80, 16 + 50,texFont,  CLR_WHITE, 2 , value);
	  if(move.x - move.radius > maxX || move.x + move.radius < 0){
	    move.x = maxX/2;
	    move.y = maxY/2;
	    pass = 0;
	  }
	}
	
	// Clean memory
	GRRLIB_Exit();
	
	exit(0);
}
